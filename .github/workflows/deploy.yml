name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # éœ€è¦å¯¹æ¯”å‰ä¸€ä¸ª commit

      - name: Restore cached builds
        id: cache-restore
        uses: actions/cache/restore@v3
        with:
          path: dist
          key: dist-cache-${{ github.sha }}
          restore-keys: |
            dist-cache-

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Install dependencies
        run: pnpm install

      - name: Detect changed packages
        id: changes
        run: |
          # æ£€æµ‹å“ªäº›åŒ…å‘ç”Ÿäº†å˜åŒ–
          if git diff --quiet HEAD^ HEAD -- packages/book2/; then
            echo "book2=false" >> $GITHUB_OUTPUT
          else
            echo "book2=true" >> $GITHUB_OUTPUT
          fi
          
          if git diff --quiet HEAD^ HEAD -- packages/cs130-vue/; then
            echo "cs130-vue=false" >> $GITHUB_OUTPUT
          else
            echo "cs130-vue=true" >> $GITHUB_OUTPUT
          fi
          
          if git diff --quiet HEAD^ HEAD -- packages/portal/; then
            echo "portal=false" >> $GITHUB_OUTPUT
          else
            echo "portal=true" >> $GITHUB_OUTPUT
          fi
          
          # å¦‚æœæ ¹é…ç½®æ–‡ä»¶å˜åŒ–ï¼Œå…¨é‡æ„å»º
          if git diff --quiet HEAD^ HEAD -- package.json pnpm-workspace.yaml; then
            echo "force-all=false" >> $GITHUB_OUTPUT
          else
            echo "force-all=true" >> $GITHUB_OUTPUT
          fi

      - name: Build changed books and portal
        run: |
          FORCE_ALL="${{ steps.changes.outputs.force-all }}"
          BOOK2_CHANGED="${{ steps.changes.outputs.book2 }}"
          CS130_CHANGED="${{ steps.changes.outputs.cs130-vue }}"
          PORTAL_CHANGED="${{ steps.changes.outputs.portal }}"
          
          # å¦‚æœæ˜¯é¦–æ¬¡éƒ¨ç½²ï¼ˆæ—  HEAD^ï¼‰æˆ–æ ¹é…ç½®å˜åŒ–ï¼Œå…¨é‡æ„å»º
          if [ "$FORCE_ALL" = "true" ] || ! git rev-parse HEAD^ &>/dev/null; then
            echo "ğŸ“¦ Full build triggered"
            pnpm --filter @codebooks/book2 run docs:build
            pnpm --filter @codebooks/cs130-vue run docs:build
          else
            # å¢é‡æ„å»º
            if [ "$BOOK2_CHANGED" = "true" ]; then
              echo "ğŸ“¦ Building book2..."
              pnpm --filter @codebooks/book2 run docs:build
            else
              echo "â­ï¸ Skipping book2 (no changes)"
            fi
            
            if [ "$CS130_CHANGED" = "true" ]; then
              echo "ğŸ“¦ Building cs130-vue..."
              pnpm --filter @codebooks/cs130-vue run docs:build
            else
              echo "â­ï¸ Skipping cs130-vue (no changes)"
            fi
          fi
          
          # Portal æ€»æ˜¯æ„å»ºï¼ˆåŒ…å«å¯¼èˆªé“¾æ¥ï¼‰
          echo "ğŸ“¦ Building portal..."
          pnpm --filter @codebooks/portal run docs:build
          
          # å°† portal å†…å®¹å¤åˆ¶åˆ° dist æ ¹ç›®å½•ï¼ˆportal ä½œä¸ºä¸»é¡µï¼‰
          cp -r dist/portal/* dist/
          rm -rf dist/portal

      - name: Save build cache
        uses: actions/cache/save@v3
        with:
          path: dist
          key: dist-cache-${{ github.sha }}

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    needs: build
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
