# 语法分析概述

语法分析是编译器的第二个主要阶段。它接收词法分析器产生的 token 序列，根据语法规则构建抽象语法树（AST）。对于 Vue 编译器，这意味着将模板的 token 序列转换为可操作的树形结构。

## 语法分析器的职责

语法分析器（Parser）负责验证输入是否符合语言的语法规则，并构建反映代码结构的 AST。如果输入不符合语法，解析器应该报告清晰的错误信息。

与词法分析关注字符不同，语法分析关注的是 token 之间的关系。词法分析回答"这些字符组成什么 token"，语法分析回答"这些 token 组成什么结构"。

## 文法与产生式

语言的语法通常用文法（Grammar）来形式化描述。文法由一组产生式（Production）组成，每个产生式描述一个语法结构如何由更小的部分组成。

比如 Vue 模板的元素可以描述为：Element → StartTag Content EndTag，StartTag → `<` TagName Attributes `>`，Attributes → Attribute Attributes | ε。这种描述叫做 BNF（巴科斯-诺尔范式）或其变体 EBNF。

产生式定义了语言的递归结构。元素可以包含子元素，子元素又可以包含更深的子元素。解析器按照产生式的规则，递归地识别这些嵌套结构。

## 解析策略

解析器有两种基本策略：自顶向下和自底向上。

自顶向下解析从起始符号开始，尝试推导出输入的 token 序列。它从整体到部分，先假设输入是一个合法程序，然后逐步细化。递归下降解析是最常见的自顶向下实现方式。

自底向上解析从输入 token 开始，逐步归约成更大的语法单元，直到归约为起始符号。LR 解析器是典型的自底向上解析器。

Vue 编译器采用递归下降解析。这种方式直观易懂，手写起来自然，对于模板这种相对简单的语法完全足够。而且递归下降解析器容易定制，可以方便地处理 Vue 模板的特殊需求。

## 递归下降解析

递归下降解析的核心思想是：为每个语法规则编写一个解析函数。函数调用关系直接对应语法的递归结构。

解析元素时，先调用 parseStartTag 解析开始标签，然后调用 parseChildren 解析内容（可能递归调用 parseElement），最后调用 parseEndTag 解析结束标签。每个函数消费它能识别的 token，返回对应的 AST 节点。

这种方式的优点是代码结构清晰，与语法规则一一对应，调试方便。缺点是可能有左递归问题，但模板语法通常不存在左递归，所以这不是问题。

## 处理优先级和结合性

在表达式解析中，优先级和结合性非常重要。`a + b * c` 应该解析为 `a + (b * c)` 而不是 `(a + b) * c`。

处理优先级的经典方法是使用多层语法规则。低优先级操作符在上层，高优先级在下层。解析时从上层开始，优先级自然就处理好了。

Vue 模板中的表达式使用标准 JavaScript 语法，Vue 编译器通常不自己解析复杂表达式，而是交给专门的 JavaScript 解析器（如 @babel/parser）处理。

## 前瞻与歧义

有些语法结构需要看多个 token 才能确定如何解析。前瞻（Lookahead）的数量影响解析器的复杂度。

LL(1) 解析器只看一个 token，足以处理大多数语法。LL(k) 看 k 个 token。有些语法需要无限前瞻，这时可能需要回溯或更强大的解析技术。

Vue 模板的设计考虑了可解析性。指令以 `v-` 或 `:` 或 `@` 开头，很容易与普通属性区分。插值用 `{{` 开始，与普通文本明确分开。这些设计让解析器只需要有限的前瞻。

## 错误恢复

理想的解析器在遇到语法错误时不应该立即停止，而应该尝试恢复并继续解析，尽可能多地发现问题。

常见的错误恢复策略包括：恐慌模式（跳过 token 直到找到同步点）、短语层恢复（用空节点替代缺失部分）、错误产生式（将常见错误显式加入语法）。

Vue 编译器的错误恢复相对简单——遇到错误时记录下来，尝试跳过问题部分继续解析。对于缺少闭合标签这类常见错误，编译器会自动补全并发出警告。

## AST 的构建

解析过程中，每识别出一个语法结构就创建对应的 AST 节点。节点之间通过 children 属性形成父子关系，最终构成一棵完整的语法树。

AST 节点的设计需要平衡几个目标。首先要完整——包含后续阶段需要的所有信息。其次要简洁——不包含无关的细节。最后要规范——结构统一便于遍历处理。

Vue 的 AST 节点使用 TypeScript 接口定义，不同类型的节点有不同的字段。比如 ElementNode 有 tag、props、children；InterpolationNode 有 content。所有节点都有 type 和 loc 字段。

## 语法糖的处理

语法糖让代码更简洁，但增加了解析复杂度。Vue 模板有很多语法糖：`:prop` 是 `v-bind:prop` 的缩写，`@event` 是 `v-on:event` 的缩写。

处理语法糖有两种策略。一种是在解析阶段展开，将语法糖转换为完整形式。另一种是保留原始形式，在转换阶段处理。

Vue 编译器倾向于在解析阶段就识别出语法糖的本质。当解析到 `:`，它会创建一个 v-bind 指令节点；解析到 `@`，创建 v-on 指令节点。这样后续阶段不需要再处理语法糖变体。

## 性能考量

语法分析的性能主要受 token 数量和树的深度影响。对于大型模板，解析时间可能成为瓶颈。

优化手段包括：减少不必要的对象创建；使用池化技术复用节点对象；增量解析（只重新解析变化的部分）。

Vue 编译器的解析器为了清晰度牺牲了一些性能，但通过整体设计保持了良好的效率。对于构建时编译场景，解析速度通常不是关键瓶颈；对于运行时编译，模板通常不会太大。

## 小结

语法分析将 token 序列转换为 AST，为后续的转换和代码生成提供结构化的输入。Vue 编译器采用递归下降解析，这种方式直观且灵活，能够很好地处理模板语法的各种需求。语法分析阶段的质量直接影响 AST 的质量，进而影响整个编译流程的可靠性。在后续章节中，我们将深入 Vue 编译器的具体解析实现。
