# 词法分析概述

词法分析是编译过程的第一步，它将源代码的字符流转换为 token 序列。对于 Vue 编译器来说，这意味着将模板字符串分解为可识别的语法单元。

## 词法分析器的角色

词法分析器（Lexer），也称为扫描器（Scanner），承担着编译器的"眼睛"功能。它逐字符读取源代码，识别出有意义的模式，将它们打包成 token 供语法分析器使用。

这种分层设计有明确的好处。首先，它简化了语法分析器的工作——语法分析器不需要处理单个字符，而是处理语义单元。其次，它允许词法层面的优化，比如跳过空白符、合并连续文本等。

## Token 的构成

一个 token 通常包含几个关键信息：类型（type）标识这是什么类型的 token，比如标签名、属性名、文本内容；值（value）是 token 的实际内容；位置（loc）记录 token 在源码中的位置，用于错误报告。

在 Vue 模板中，常见的 token 类型包括标签开始符 `<`、标签结束符 `>`、标签名如 `div`、属性名如 `class`、属性值如 `"hello"`、插值开始 `{{`、插值结束 `}}`、文本内容等。

## 有限状态机

词法分析器通常用有限状态机（FSM）来实现。状态机有一组状态，读取字符时根据当前状态和输入字符决定转移到哪个状态。

考虑解析 `<div>`。初始状态读到 `<`，进入"标签开始"状态。继续读取 `d`、`i`、`v`，这些字符被收集为标签名。读到 `>`，标签名结束，产生标签 token。

Vue 的模板解析采用了类似的状态机思想，但不是严格的形式化状态机。它使用一系列 parse 函数，每个函数处理特定类型的内容，函数之间相互调用形成解析流程。

## HTML 词法分析的复杂性

HTML 的词法分析比常规编程语言复杂，因为 HTML 的语法规则更松散。

首先是上下文敏感性。在 `<script>` 标签内，`<` 不再表示标签开始，而是普通字符。在属性值中，`>` 不表示标签结束。词法分析器需要追踪当前的解析上下文。

其次是容错性。浏览器的 HTML 解析器非常宽容——缺少闭合标签、属性值没有引号，这些都能被接受。虽然 Vue 模板要求更严格，但仍需要处理各种边界情况。

还有实体解码的问题。HTML 中的 `&lt;` 表示 `<`，`&amp;` 表示 `&`。词法分析器需要识别并解码这些实体。

## Vue 模板的词法单元

Vue 模板扩展了 HTML，增加了自己的词法单元。

插值表达式 `{{ expression }}` 是最常用的扩展。双大括号之间是 JavaScript 表达式。词法分析器需要正确识别插值边界，特别是处理表达式中可能出现的 `}` 字符。

指令语法如 `v-if`、`:prop`、`@event` 也需要特殊处理。词法分析器需要识别指令前缀，区分普通属性和指令属性。

## 前瞻与回溯

有时候，单看当前字符无法确定 token 类型。这时需要前瞻（lookahead）——查看后续字符再做决定。

比如区分 `<div>` 和 `</div>`。读到 `<` 后，需要看下一个字符：如果是 `/`，这是结束标签；否则是开始标签。

回溯（backtracking）是指当发现走错路时，退回去重新尝试其他路径。良好设计的词法规则应该避免回溯，因为它影响性能。Vue 的模板语法设计考虑了这一点，使得解析过程基本不需要回溯。

## 位置追踪

词法分析器需要追踪每个 token 的源码位置。这对错误报告和 source map 生成至关重要。

位置信息通常包括行号、列号和偏移量。Vue 编译器使用 `SourceLocation` 结构，包含 start 和 end 两个位置点，每个点有 offset、line、column 三个字段。

精确的位置追踪让编译错误能够准确指向问题所在。这在开发体验上非常重要——模糊的错误信息会严重影响调试效率。

## 错误处理

词法分析阶段可能遇到各种错误：未闭合的标签、无效的字符序列、错误的实体引用等。

好的词法分析器应该在发现错误时继续尝试解析，尽可能多地报告问题。这种错误恢复策略让开发者一次性看到多个错误，而不是修一个再发现下一个。

Vue 编译器在词法分析阶段会收集错误，但不会立即中断。解析完成后统一报告所有发现的问题，同时提供足够的上下文信息帮助定位。

## 性能考量

词法分析是编译器中执行频率最高的阶段——每个字符都要被扫描。因此性能优化在这里特别重要。

常见的优化手段包括：避免频繁的字符串操作（使用索引而不是 substring）；使用查表代替条件判断（字符类型查表）；减少内存分配（复用对象）。

Vue 编译器在词法分析阶段使用游标（cursor）遍历源码，通过位置索引来提取子串，避免创建大量中间字符串。这种设计在大型模板的编译中能显著降低内存压力。

## 小结

词法分析将模板字符流转换为结构化的 token 序列，为后续的语法分析铺平道路。Vue 模板的词法分析需要处理 HTML 的复杂性、Vue 特有的插值和指令语法，同时保持精确的位置追踪和友好的错误报告。虽然词法分析看起来简单，但它是整个编译流程的基础，其设计质量直接影响后续阶段的实现复杂度。
